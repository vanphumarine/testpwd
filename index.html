<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Pro Tracker">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker Realtime</title>
    <!-- Tailwind CSS CDN to use utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for modern interface -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for plotting charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Basic CSS for font and background color */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Minimum height for Kanban columns to ensure visual consistency */
        .kanban-column {
            min-height: 400px;
            max-height: calc(100vh - 280px); /* Adjust based on header/footer height */
            overflow-y: auto; /* Enable independent vertical scrolling */
            padding-right: 1rem; /* Add padding for scrollbar visibility */
        }
        /* Styling for the scrollbar */
        .kanban-column::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }

        .kanban-column::-webkit-scrollbar-track {
            background: #e0e0e0; /* Track color */
            border-radius: 4px;
        }

        .kanban-column::-webkit-scrollbar-thumb {
            background-color: #a0a0a0; /* Thumb color */
            border-radius: 4px;
            border: 2px solid #e0e0e0; /* Padding around thumb */
        }

        .kanban-column::-webkit-scrollbar-thumb:hover {
            background-color: #808080; /* Darker thumb on hover */
        }

        /* Task card styling and hover effects for admin */
        .task-card {
            transition: all 0.2s ease-in-out; /* Smooth transition on drag/hover */
            /* border-left-width: 8px; /* Adjusted dynamically, so remove static */
            border-width: 1px; /* Add a subtle border on all sides for consistency */
        }
        .task-card.is-admin {
            cursor: grab; /* Indicates draggable for admin */
        }
        .task-card.is-admin:hover {
            transform: translateY(-2px); /* Slightly lift on hover */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Soft shadow on hover */
        }
        /* Styling for the task card being dragged */
        .task-card.dragging {
            opacity: 0.5; /* Fade out */
            transform: rotate(3deg); /* Rotate slightly */
        }
        /* Highlight drop location when dragging/dropping task */
        .task-card.drag-over-target {
            border: 2px dashed #6366f1; /* Purple dashed border */
            padding-top: 2rem; /* Create space at the top to indicate insertion point */
            padding-bottom: 2rem; /* Create space at the bottom */
        }
        .kanban-column.drag-over-empty {
            border: 2px dashed #6366f1; /* Dashed border for empty column */
        }

        /* Container for confetti celebration effect */
        #confetti-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Allow interaction with elements below */
            overflow: hidden; /* Hide overflowing confetti */
            z-index: 9999; /* Ensure it's on top */
        }
        /* Styling and animation for each confetti piece */
        .confetti {
            position: absolute;
            width: 10px; height: 10px;
            background-color: #f00; /* Default red, will be overridden */
            opacity: 0; /* Start invisible */
            animation: fall 4s linear forwards; /* Falling animation */
        }
        /* Keyframe animation for falling confetti */
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; } /* Start from top, visible */
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } /* Fall to bottom, fade out */
        }
        /* Modal backdrop for overlay effect */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); /* Semi-transparent black overlay */
            display: flex; justify-content: center; align-items: center; /* Center content */
            z-index: 10000; /* Ensure it's on top of all other elements */
        }
        /* Modal content box styling */
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* Large shadow */
            text-align: center;
        }
        /* Modal button styling */
        .modal-button {
            margin-top: 1.5rem; padding: 0.5rem 1.5rem; border-radius: 0.375rem;
            background-color: #4f46e5; color: white; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-button:hover {
            background-color: #4338ca; /* Darker on hover */
        }
        /* Notification Toast */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            /* Initial state: hidden and collapsed */
            opacity: 0;
            visibility: hidden;
            transform: translateX(calc(100% + 20px)); /* Start completely off-screen */
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out, transform 0.5s ease-in-out;
            z-index: 11000; /* Higher than modals */
            display: flex; /* Use flexbox for layout */
            flex-direction: column; /* Stack content vertically */
            align-items: flex-start; /* Align content to the start */
            max-width: 300px; /* Limit width */
            cursor: pointer; /* Indicate it's clickable even when collapsed */
        }
        .toast-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0); /* Fully visible and expanded */
        }
        /* Collapsed state for the toast when it is shown */
        .toast-notification.show.collapsed {
            transform: translateX(calc(100% - 40px)); /* Shift left to hide most content */
            opacity: 0.7; /* Keep it semi-transparent when collapsed */
        }
        .toast-notification .toast-content {
            display: block;
            max-height: 100px; /* Max height for content when expanded */
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out;
            width: 100%; /* Ensure content takes full width when expanded */
        }
        .toast-notification.show.collapsed .toast-content {
            max-height: 0; /* Collapse content */
            opacity: 0;
            padding: 0;
        }
        .toast-notification .toggle-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            align-self: flex-end; /* Align button to the right within the flex container */
            transition: transform 0.3s ease-in-out;
        }
        .toast-notification.show.collapsed .toggle-button {
            transform: rotate(180deg); /* Rotate arrow when collapsed */
        }


        /* Subtask drag-over effect */
        .subtask-item.drag-over-subtask {
            border-bottom: 2px dashed #6366f1; /* Purple dashed border */
            padding-bottom: 0.5rem;
        }

        /* NEW: Styles for comment and note action buttons */
        .comment-note-actions {
            display: flex;
            gap: 4px; /* Space between buttons */
            position: absolute; /* Position relative to parent */
            top: 2px; /* Adjust as needed */
            right: 2px; /* Adjust as needed */
        }
        .comment-note-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem; /* text-sm */
            line-height: 1;
            padding: 4px; /* p-1 */
            border-radius: 0.25rem; /* rounded */
            transition: background-color 0.1s ease-in-out;
        }
        .comment-note-actions button:hover {
            background-color: rgba(255, 255, 255, 0.2); /* Light hover effect */
        }
        .comment-note-actions .delete-button {
            color: #ef4444; /* red-500 */
        }
        .comment-note-actions .delete-button:hover {
            color: #dc2626; /* red-600 */
        }
        .comment-note-actions .edit-button {
            color: #9ca3af; /* gray-400 */
        }
        .comment-note-actions .edit-button:hover {
            color: #6b7280; /* gray-600 */
        }

        /* Custom styles for the countdown timer inspired by the image */
        .countdown-card {
            width: 128px; /* w-32 */
            height: 128px; /* h-32 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            border: 1px solid #e5e7eb; /* border border-gray-200 */
            overflow: hidden;
            position: relative;
            font-family: 'Inter', sans-serif; /* Ensure Inter font */
        }

        .countdown-card .header-text {
            position: absolute;
            top: 0;
            width: 100%;
            background-image: linear-gradient(to right, #3b82f6, #60a5fa); /* blue-600 to blue-400 */
            color: white;
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            text-transform: uppercase;
            padding: 0.375rem 0; /* py-1.5 */
            text-align: center;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }

        .countdown-card .days-value {
            font-size: 3rem; /* text-5xl */
            font-weight: 300; /* font-light */
            color: #374151; /* gray-800 */
            margin-top: 1rem; /* mt-4 */
        }

        /* NEW: Styles for subtask reaction buttons on hover */
        .subtask-reactions-container {
            position: absolute; /* Positioned relative to .subtask-item */
            bottom: 2px; /* Adjust as needed */
            left: 50%; /* Centered horizontally */
            transform: translateX(-50%); /* Pull back by half its width to truly center */
            display: flex; /* Always flex for layout */
            align-items: center;
            gap: 4px;
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent background */
            padding: 4px 8px; /* Padding around buttons */
            border-radius: 1rem; /* pill shape */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtle shadow */
            transition: all 0.2s ease-in-out;
            opacity: 0; /* Start hidden */
            pointer-events: none; /* Prevent interaction when hidden */
            z-index: 5; /* Ensure it's above normal content but below admin buttons */
        }

        .subtask-item:hover .subtask-reactions-container {
            opacity: 1; /* Fully visible on hover */
            pointer-events: auto; /* Enable interaction on hover */
        }

        .subtask-reactions-container .reaction-button {
            position: relative; /* For tooltip positioning */
            font-size: 0.875rem; /* text-sm */
            padding: 4px 8px; /* py-1 px-2 */
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
            transition: background-color 0.1s ease-in-out, transform 0.1s ease-in-out;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap; /* Keep text on one line */
        }

        .subtask-reactions-container .reaction-button:hover {
            transform: translateY(-1px); /* Little lift on hover */
        }

        /* Styles for active/inactive reactions */
        .subtask-reactions-container .reaction-button.reacted {
            background-color: #bfdbfe; /* blue-200 */
            border: 1px solid #93c5fd; /* blue-300 */
            color: #1e40af; /* blue-800 */
        }

        .subtask-reactions-container .reaction-button.not-reacted {
            background-color: #e5e7eb; /* gray-200 */
            border: 1px solid #d1d5db; /* gray-300 */
            color: #4b5563; /* gray-700 */
        }
        
        /* Reaction tooltip styles */
        .reaction-tooltip {
            position: absolute;
            bottom: calc(100% + 5px); /* Position above the button */
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem; /* text-xs */
            white-space: normal; /* Allow text to wrap */
            text-align: center;
            max-width: 150px; /* Limit width */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            z-index: 10; /* Ensure it's above other elements */
        }

        .reaction-tooltip::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px; /* Position below for a caret effect */
            transform: translateX(-50%) rotate(45deg);
            width: 10px;
            height: 10px;
            background-color: #333;
        }

        .reaction-button:hover .reaction-tooltip {
            opacity: 1;
            visibility: visible;
        }

    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center">
            <h2 class="text-3xl font-bold mb-6 text-gray-900">Welcome to Project Tracker Realtime</h2>
            <p class="text-gray-600 mb-6">Choose how you want to access the application.</p>
            
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Login</h3>
                <input type="email" id="admin-email" placeholder="Email" class="w-full p-3 mb-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="admin-password" placeholder="Password" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="admin-login-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-indigo-700 transition-colors duration-300">Login</button>
            </div>

            <!-- Removed Viewer Access section -->
            <!--
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Viewer Access</h3>
                <button id="guest-login-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-green-700 transition-colors duration-300">Continue as Guest</button>
            </div>
            -->
        </div>
    </div>

    <!-- Main Kanban App (initially hidden) -->
    <div id="app" class="p-4 md:p-8 min-h-screen hidden">
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Project Tracker Realtime</h1>
        </header>

        <!-- Top Controls: Project Selection/Creation & Auth Info -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-2 mb-4 max-w-full mx-auto">
            <!-- Left: Project Selection and Label -->
            <div class="flex items-center gap-2 flex-wrap justify-center md:justify-start">
                <label for="project-select" class="text-lg font-medium text-gray-700 whitespace-nowrap">Select Project:</label>
                <select id="project-select" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition max-w-xs w-full md:w-auto">
                    <option value="">Select a Project</option>
                </select>
                <button id="create-project-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors duration-300">Create New Project</button>
            </div>
            
            <!-- Right: Auth Info & Logout Button -->
            <div id="auth-info" class="text-sm text-gray-500 flex flex-row items-center gap-2 flex-wrap justify-center md:justify-end mt-2 md:mt-0">
                <!-- Changed to display nickname -->
                <p>User: <span class="font-bold text-gray-800" id="display-user-id"></span></p>
                <p>Your Role: <span class="font-bold" id="display-user-role"></span></p>
                <!-- NEW: Change Password Button -->
                <button id="recent-events-btn" class="bg-indigo-500 text-white text-sm px-3 py-1 rounded-md hover:bg-indigo-600 transition-colors duration-300">Recent Events</button>
                <button id="change-password-btn" class="bg-blue-500 text-white text-sm px-3 py-1 rounded-md hover:bg-blue-600 transition-colors duration-300">Change Password</button>
                <button id="logout-btn" class="bg-red-500 text-white text-sm px-3 py-1 rounded-md hover:bg-red-600 transition-colors duration-300">Logout</button>
            </div>
        </div>

        <!-- Project Details and Add Task Form - Now stacked vertically (flex-col) and centered with max-width -->
        <div class="flex flex-col gap-4 mb-4 max-w-full mx-auto">
            <!-- Current Project Details Display -->
            <div id="current-project-details" class="w-full bg-blue-100 p-4 rounded-lg shadow-md hidden text-left border-l-4 border-blue-500 flex flex-wrap items-start justify-between">
                <div class="flex-grow">
                    <h2 class="text-2xl font-bold text-blue-800 mb-2" id="display-project-name"></h2>
                    <p class="text-gray-700 mb-3" id="display-project-description"></p>
                    <!-- Updated layout for project details -->
                    <div class="flex flex-col gap-1 text-sm text-gray-600">
                        <div class="flex items-center gap-1">
                            <strong class="text-blue-700">Start Date:</strong>
                            <span id="display-project-start-date"></span>
                        </div>
                        <div class="flex items-center gap-1">
                            <strong class="text-blue-700">End Date:</strong>
                            <span id="display-project-end-date"></span>
                        </div>
                        <div class="flex items-center gap-1">
                            <strong class="text-blue-700">Status:</strong>
                            <span id="display-project-status" class="font-semibold"></span>
                        </div>
                        <div class="flex items-center gap-1">
                            <strong class="text-blue-700">Members:</strong>
                            <span id="display-project-members" class="font-semibold"></span>
                        </div>
                    </div>
                </div>
                <!-- Countdown Timer -->
                <div id="countdown-timer" class="mt-4 sm:mt-0 ml-0 sm:ml-4 hidden">
                    <div class="countdown-card">
                        <div class="header-text">
                            Days Until Seatrial
                        </div>
                        <div id="countdown-days-value" class="days-value">0</div>
                    </div>
                </div>
                <!-- Action buttons for project, displayed based on permissions -->
                <div class="w-full text-right mt-3 flex justify-end gap-2">
                    <button id="edit-project-btn" class="bg-blue-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-blue-600 transition-colors duration-300">Edit Project</button>
                    <button id="manage-members-btn" class="bg-purple-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-purple-600 transition-colors duration-300">Manage Members</button>
                    <button id="delete-project-btn" class="bg-red-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-red-600 transition-colors duration-300">Delete Project</button>
                </div>
            </div>

            <!-- Form to add new task -->
            <div id="add-task-container" class="w-full bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Add New Task</h2>
                <form id="add-task-form" class="flex flex-col gap-3">
                    <input type="text" id="task-input" placeholder="Enter a new task..." class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="flex items-center gap-1 flex-grow">
                            <label for="task-deadline-input" class="text-gray-700 whitespace-nowrap text-sm">Deadline:</label>
                            <input type="date" id="task-deadline-input" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition text-sm">
                        </div>
                    </div>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors duration-300 w-full sm:w-auto">Add Task</button>
                </form>
            </div>
        </div>

        <!-- Kanban Board Columns -->
        <div id="kanban-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- To Do Column -->
            <div id="todo" class="kanban-column bg-gray-200 p-4 rounded-lg shadow-inner flex flex-col gap-4" ondrop="drop(event)" ondragover="allowDrop(event)">
                <h2 class="text-xl font-semibold text-gray-700 sticky top-0 bg-gray-200 py-2">To Do</h2>
            </div>
            <!-- In Progress Column -->
            <div id="in-progress" class="kanban-column bg-blue-200 p-4 rounded-lg shadow-inner flex flex-col gap-4" ondrop="drop(event)" ondragover="allowDrop(event)">
                <h2 class="text-xl font-semibold text-blue-700 sticky top-0 bg-blue-200 py-2">In Progress</h2>
            </div>
            <!-- In Review Column -->
            <div id="in-review" class="kanban-column bg-yellow-200 p-4 rounded-lg shadow-inner flex flex-col gap-4" ondrop="drop(event)" ondragover="allowDrop(event)">
                <h2 class="text-xl font-semibold text-yellow-700 sticky top-0 bg-yellow-200 py-2">In Review</h2>
            </div>
            <!-- Done Column -->
            <div id="done" class="kanban-column bg-green-200 p-4 rounded-lg shadow-inner flex flex-col gap-4" ondrop="drop(event)" ondragover="allowDrop(event)">
                <h2 class="text-xl font-semibold text-green-700 sticky top-0 bg-green-200 py-2">Done</h2>
            </div>
        </div>
    </div>

    <!-- Modal for adding/editing project -->
    <div id="project-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full text-left transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full">
            <h3 class="text-2xl leading-6 font-bold text-gray-900 mb-6" id="modal-title">Create New Project</h3>
            <form id="project-form" class="space-y-4">
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-700">Project Name</label>
                    <input type="text" id="project-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="project-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="project-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="project-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="project-start-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="project-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="project-end-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>
                <div>
                    <label for="project-status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="project-status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="planning">Planning</option>
                        <option value="in-progress">In Progress</option>
                        <option value="complete">Complete</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="close-project-modal" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="project-submit-btn">Create</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal for task details -->
    <div id="task-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full text-left transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl leading-6 font-bold text-gray-900" id="task-modal-title">Task Details</h3>
                <button id="close-task-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="task-modal-form" class="space-y-4">
                <!-- Task title and description -->
                <div>
                    <label for="task-modal-title-input" class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="task-modal-title-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="task-modal-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="task-modal-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                </div>
                <!-- Status, Priority, and Deadline -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="task-modal-status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="task-modal-status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="todo">To Do</option>
                            <option value="in-progress">In Progress</option>
                            <option value="in-review">In Review</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-modal-priority" class="block text-sm font-medium text-gray-700">Priority</label>
                        <select id="task-modal-priority" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-modal-deadline" class="block text-sm font-medium text-gray-700">Deadline</label>
                        <input type="date" id="task-modal-deadline" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>
                <!-- Assignee -->
                <div>
                    <label for="task-modal-assignee" class="block text-sm font-medium text-gray-700">Assignee</label>
                    <input type="text" id="task-modal-assignee" placeholder="User nickname or email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>

                <!-- Subtasks Section -->
                <div id="subtasks-section" class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-800 mb-2">Subtasks</h4>
                    <ul id="subtasks-list" class="space-y-2 mb-4 list-none p-0">
                        <!-- Subtasks will be dynamically added here -->
                    </ul>
                    <div class="flex items-center gap-2">
                        <input type="text" id="new-subtask-input" placeholder="Add a new subtask..." class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:text-sm">
                        <button type="button" id="add-subtask-btn" class="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 transition-colors">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Comments & Notes Section -->
                <div id="comments-section" class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-800 mb-2">Comments & Notes</h4>
                    <div id="comments-list" class="space-y-4 mb-4">
                        <!-- Comments will be dynamically added here -->
                    </div>
                    <div class="flex items-start gap-2">
                        <textarea id="new-comment-input" rows="3" placeholder="Add a new comment or note..." class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:text-sm"></textarea>
                        <button type="button" id="add-comment-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors self-end">Add</button>
                    </div>
                </div>

                <!-- Buttons at the bottom of the modal -->
                <div class="flex justify-between items-center mt-6">
                    <button type="button" id="delete-task-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600 transition-colors duration-300">Delete Task</button>
                    <div class="flex gap-3">
                        <button type="button" id="task-modal-cancel" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
                        <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="task-modal-save">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for managing project members -->
    <div id="manage-members-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-left">
            <h3 class="text-2xl leading-6 font-bold text-gray-900 mb-4">Manage Project Members</h3>
            <div id="members-list" class="space-y-3 mb-4">
                <!-- Members will be dynamically added here -->
            </div>
            <div class="flex flex-col gap-2">
                <h4 class="text-md font-semibold text-gray-800">Add New Member</h4>
                <div class="flex gap-2">
                    <input type="email" id="new-member-email" placeholder="Member email" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:text-sm">
                    <select id="new-member-role" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:text-sm">
                        <option value="admin">Admin</option>
                        <option value="member">Member</option>
                        <option value="viewer">Viewer</option>
                    </select>
                    <button id="add-member-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors duration-300">Add</button>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" id="close-members-modal" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for Recent Events -->
    <div id="recent-events-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full text-left">
            <h3 class="text-2xl leading-6 font-bold text-gray-900 mb-4">Recent Events</h3>
            <ul id="events-list" class="space-y-2 text-sm text-gray-700 max-h-96 overflow-y-auto">
                <!-- Events will be dynamically added here -->
            </ul>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-events-modal" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for changing password -->
    <div id="change-password-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-left">
            <h3 class="text-2xl leading-6 font-bold text-gray-900 mb-4">Change Password</h3>
            <form id="change-password-form" class="space-y-4">
                <div>
                    <label for="current-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                    <input type="password" id="current-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                    <input type="password" id="new-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                    <input type="password" id="confirm-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="close-password-modal" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- General Purpose Modal -->
    <div id="general-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl max-w-md w-full text-center">
            <p id="general-modal-message" class="text-gray-700 mb-4"></p>
            <button id="general-modal-close-btn" class="modal-button">OK</button>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-notification">
        <div class="flex items-center justify-between w-full">
            <span class="text-lg font-bold" id="toast-title"></span>
            <button id="toast-toggle-btn" class="toggle-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
            </button>
        </div>
        <div id="toast-content" class="toast-content">
            <p id="toast-message" class="text-sm"></p>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, onSnapshot, getDocs, updateDoc, arrayUnion, arrayRemove, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI elements
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        // const guestLoginBtn = document.getElementById('guest-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const changePasswordBtn = document.getElementById('change-password-btn');
        const projectSelect = document.getElementById('project-select');
        const createProjectBtn = document.getElementById('create-project-btn');
        const displayUserId = document.getElementById('display-user-id');
        const displayUserRole = document.getElementById('display-user-role');
        const currentProjectDetails = document.getElementById('current-project-details');
        const displayProjectName = document.getElementById('display-project-name');
        const displayProjectDescription = document.getElementById('display-project-description');
        const displayProjectStartDate = document.getElementById('display-project-start-date');
        const displayProjectEndDate = document.getElementById('display-project-end-date');
        const displayProjectStatus = document.getElementById('display-project-status');
        const displayProjectMembers = document.getElementById('display-project-members');
        const countdownTimer = document.getElementById('countdown-timer');
        const countdownDaysValue = document.getElementById('countdown-days-value');
        const editProjectBtn = document.getElementById('edit-project-btn');
        const manageMembersBtn = document.getElementById('manage-members-btn');
        const deleteProjectBtn = document.getElementById('delete-project-btn');
        const addTaskContainer = document.getElementById('add-task-container');
        const addTaskForm = document.getElementById('add-task-form');
        const taskInput = document.getElementById('task-input');
        const taskDeadlineInput = document.getElementById('task-deadline-input');
        const kanbanBoard = document.getElementById('kanban-board');
        const projectModal = document.getElementById('project-modal');
        const closeProjectModalBtn = document.getElementById('close-project-modal');
        const projectForm = document.getElementById('project-form');
        const projectSubmitBtn = document.getElementById('project-submit-btn');
        const projectNameInput = document.getElementById('project-name');
        const projectDescriptionInput = document.getElementById('project-description');
        const projectStartDateInput = document.getElementById('project-start-date');
        const projectEndDateInput = document.getElementById('project-end-date');
        const projectStatusInput = document.getElementById('project-status');
        const taskModal = document.getElementById('task-modal');
        const closeTaskModalBtn = document.getElementById('close-task-modal');
        const taskModalTitleInput = document.getElementById('task-modal-title-input');
        const taskModalDescription = document.getElementById('task-modal-description');
        const taskModalStatus = document.getElementById('task-modal-status');
        const taskModalPriority = document.getElementById('task-modal-priority');
        const taskModalDeadline = document.getElementById('task-modal-deadline');
        const taskModalAssignee = document.getElementById('task-modal-assignee');
        const subtasksList = document.getElementById('subtasks-list');
        const newSubtaskInput = document.getElementById('new-subtask-input');
        const addSubtaskBtn = document.getElementById('add-subtask-btn');
        const commentsList = document.getElementById('comments-list');
        const newCommentInput = document.getElementById('new-comment-input');
        const addCommentBtn = document.getElementById('add-comment-btn');
        const deleteTaskBtn = document.getElementById('delete-task-btn');
        const taskModalSaveBtn = document.getElementById('task-modal-save');
        const manageMembersModal = document.getElementById('manage-members-modal');
        const membersList = document.getElementById('members-list');
        const newMemberEmailInput = document.getElementById('new-member-email');
        const newMemberRoleSelect = document.getElementById('new-member-role');
        const addMemberBtn = document.getElementById('add-member-btn');
        const closeMembersModalBtn = document.getElementById('close-members-modal');
        const recentEventsBtn = document.getElementById('recent-events-btn');
        const recentEventsModal = document.getElementById('recent-events-modal');
        const eventsList = document.getElementById('events-list');
        const closeEventsModalBtn = document.getElementById('close-events-modal');
        const changePasswordModal = document.getElementById('change-password-modal');
        const closePasswordModalBtn = document.getElementById('close-password-modal');
        const changePasswordForm = document.getElementById('change-password-form');
        const currentPasswordInput = document.getElementById('current-password');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const generalModal = document.getElementById('general-modal');
        const generalModalMessage = document.getElementById('general-modal-message');
        const generalModalCloseBtn = document.getElementById('general-modal-close-btn');
        const toastContainer = document.getElementById('toast-container');
        const toastTitle = document.getElementById('toast-title');
        const toastMessage = document.getElementById('toast-message');
        const toastToggleButton = document.getElementById('toast-toggle-btn');

        // Global state
        let currentUserId = null;
        let currentUserRole = 'viewer';
        let currentProjectId = null;
        let projectsData = {};
        let usersData = {};
        let tasksData = {};
        let selectedTaskForModal = null;
        let unsubscribeFromTasks = null;
        let unsubscribeFromProject = null;

        // Utility functions
        function showModal(message) {
            generalModalMessage.textContent = message;
            generalModal.classList.remove('hidden');
        }

        function closeModal() {
            generalModal.classList.add('hidden');
        }

        function showToast(title, message) {
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            toastContainer.classList.add('show');
            // Hide the toast after 5 seconds
            setTimeout(() => {
                toastContainer.classList.remove('show');
                toastContainer.classList.remove('collapsed');
            }, 5000);
        }

        toastToggleButton.addEventListener('click', () => {
            toastContainer.classList.toggle('collapsed');
        });

        function showElement(element) {
            element.classList.remove('hidden');
        }

        function hideElement(element) {
            element.classList.add('hidden');
        }

        function getProjectCollection() {
            return collection(db, `artifacts/${appId}/public/data/projects`);
        }

        function getUsersCollection() {
            return collection(db, `artifacts/${appId}/public/data/users`);
        }

        function getTasksCollection(projectId) {
            return collection(db, `artifacts/${appId}/public/data/projects/${projectId}/tasks`);
        }

        function getEventsCollection(projectId) {
            return collection(db, `artifacts/${appId}/public/data/projects/${projectId}/events`);
        }
        
        // This function logs events to a Firestore collection
        async function logEvent(projectId, eventType, details) {
            if (!projectId) {
                console.error("Cannot log event without a projectId.");
                return;
            }
            try {
                await addDoc(getEventsCollection(projectId), {
                    eventType: eventType,
                    details: details,
                    timestamp: new Date()
                });
            } catch (error) {
                console.error("Error logging event: ", error);
            }
        }

        // Authentication & User Management
        async function initializeFirebase() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error signing in:", error);
                showModal("Failed to sign in. Please try again later.");
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                // Fetch user data from Firestore
                const userDocRef = doc(getUsersCollection(), currentUserId);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    currentUserRole = userData.role || 'viewer';
                    displayUserId.textContent = userData.nickname || 'N/A';
                    displayUserRole.textContent = currentUserRole;
                } else {
                    // This case should not happen if the user is authenticated via custom token
                    // but we handle it as a fallback
                    console.warn("User document not found for authenticated user.");
                    currentUserRole = 'viewer';
                    displayUserId.textContent = 'N/A';
                    displayUserRole.textContent = 'viewer';
                }

                showElement(appScreen);
                hideElement(loginScreen);
                fetchProjects();
            } else {
                currentUserId = null;
                currentUserRole = 'viewer';
                showElement(loginScreen);
                hideElement(appScreen);
                // Clear state when logged out
                projectSelect.innerHTML = '<option value="">Select a Project</option>';
                displayProjectDetails(null);
                renderTasks();
            }
        });

        adminLoginBtn.addEventListener('click', async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;

            if (email && password) {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login failed:", error);
                    showModal("Invalid email or password.");
                }
            } else {
                showModal("Please enter both email and password for login.");
            }
        });

        // Removed the event listener for guest login button as the button itself is removed
        // guestLoginBtn.addEventListener('click', handleGuestLogin); 

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
                showModal("Failed to log out. Please try again.");
            }
        });

        changePasswordBtn.addEventListener('click', () => {
            showElement(changePasswordModal);
        });

        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showModal("No user is currently logged in.");
                return;
            }

            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (newPassword !== confirmPassword) {
                showModal("New password and confirmation do not match.");
                return;
            }
            if (newPassword.length < 6) {
                showModal("Password should be at least 6 characters.");
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                showModal("Password changed successfully!");
                hideElement(changePasswordModal);
                changePasswordForm.reset();
            } catch (error) {
                console.error("Error changing password:", error);
                if (error.code === 'auth/wrong-password') {
                    showModal("The current password you entered is incorrect.");
                } else if (error.code === 'auth/weak-password') {
                    showModal("The new password is too weak.");
                } else {
                    showModal("Failed to change password. Please try again.");
                }
            }
        });

        // Project and Task Management
        async function fetchProjects() {
            try {
                const q = query(getProjectCollection());
                const querySnapshot = await getDocs(q);
                projectsData = {};
                projectSelect.innerHTML = '<option value="">Select a Project</option>';

                querySnapshot.forEach((doc) => {
                    const project = doc.data();
                    const projectId = doc.id;
                    projectsData[projectId] = { id: projectId, ...project };
                    // Check if the current user is a member of the project
                    const isMember = project.members && project.members.some(member => member.uid === currentUserId);
                    if (isMember || currentUserRole === 'admin') {
                        const option = document.createElement('option');
                        option.value = projectId;
                        option.textContent = project.name;
                        projectSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error("Error fetching projects:", error);
            }
        }

        async function createProject(project) {
            try {
                await addDoc(getProjectCollection(), project);
                showModal("Project created successfully!");
                hideElement(projectModal);
                projectForm.reset();
                fetchProjects();
            } catch (error) {
                console.error("Error creating project:", error);
                showModal("Failed to create project. Please try again.");
            }
        }

        async function updateProject(projectId, updates) {
            try {
                await updateDoc(doc(getProjectCollection(), projectId), updates);
                showModal("Project updated successfully!");
                hideElement(projectModal);
            } catch (error) {
                console.error("Error updating project:", error);
                showModal("Failed to update project. Please try again.");
            }
        }

        async function deleteProject(projectId) {
            const confirmed = window.confirm("Are you sure you want to delete this project? All tasks will be lost.");
            if (!confirmed) return;

            try {
                // First delete all tasks within the project
                const tasksQuery = query(getTasksCollection(projectId));
                const tasksSnapshot = await getDocs(tasksQuery);
                const deletePromises = tasksSnapshot.docs.map(taskDoc => deleteDoc(taskDoc.ref));
                await Promise.all(deletePromises);
                
                // Then delete the project itself
                await deleteDoc(doc(getProjectCollection(), projectId));
                showModal("Project and all its tasks deleted successfully!");
                fetchProjects();
            } catch (error) {
                console.error("Error deleting project:", error);
                showModal("Failed to delete project. Please try again.");
            }
        }
        
        async function addMemberToProject(projectId, memberEmail, role) {
            try {
                // Get the user data to find the UID
                const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersRef, where("email", "==", memberEmail));
                const userSnapshot = await getDocs(q);

                if (userSnapshot.empty) {
                    showModal("User with this email not found. Please ask them to log in once to create an account.");
                    return;
                }

                const userData = userSnapshot.docs[0].data();
                const userUid = userSnapshot.docs[0].id;

                const projectRef = doc(getProjectCollection(), projectId);
                const projectSnap = await getDoc(projectRef);
                const projectData = projectSnap.data();

                // Check if the user is already a member
                const isAlreadyMember = projectData.members && projectData.members.some(member => member.uid === userUid);
                if (isAlreadyMember) {
                    showModal("This user is already a member of the project.");
                    return;
                }

                await updateDoc(projectRef, {
                    members: arrayUnion({ uid: userUid, email: memberEmail, nickname: userData.nickname, role: role })
                });

                showModal("Member added successfully!");
            } catch (error) {
                console.error("Error adding member:", error);
                showModal("Failed to add member. Please try again.");
            }
        }

        async function removeMemberFromProject(projectId, memberUid) {
            try {
                const projectRef = doc(getProjectCollection(), projectId);
                const projectSnap = await getDoc(projectRef);
                const projectData = projectSnap.data();
                const updatedMembers = projectData.members.filter(member => member.uid !== memberUid);

                await updateDoc(projectRef, {
                    members: updatedMembers
                });

                showModal("Member removed successfully!");
            } catch (error) {
                console.error("Error removing member:", error);
                showModal("Failed to remove member. Please try again.");
            }
        }

        function displayProjectDetails(project) {
            if (project) {
                showElement(currentProjectDetails);
                displayProjectName.textContent = project.name;
                displayProjectDescription.textContent = project.description;
                displayProjectStartDate.textContent = project.startDate;
                displayProjectEndDate.textContent = project.endDate;
                displayProjectStatus.textContent = project.status;
                displayProjectMembers.innerHTML = project.members.map(m => `<span class="bg-gray-200 text-gray-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${m.nickname} (${m.role})</span>`).join('');
                // Display countdown
                const today = new Date();
                const endDate = new Date(project.endDate);
                const diffTime = endDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays >= 0) {
                    countdownDaysValue.textContent = diffDays;
                    showElement(countdownTimer);
                } else {
                    hideElement(countdownTimer);
                }

                const isProjectAdmin = project.members.some(m => m.uid === currentUserId && m.role === 'admin');
                const isSuperAdmin = currentUserRole === 'admin';
                if (isProjectAdmin || isSuperAdmin) {
                    showElement(editProjectBtn);
                    showElement(manageMembersBtn);
                    showElement(deleteProjectBtn);
                } else {
                    hideElement(editProjectBtn);
                    hideElement(manageMembersBtn);
                    hideElement(deleteProjectBtn);
                }
            } else {
                hideElement(currentProjectDetails);
                hideElement(countdownTimer);
            }
        }
        
        function setupRealtimeListener(projectId) {
            if (unsubscribeFromTasks) unsubscribeFromTasks();
            if (unsubscribeFromProject) unsubscribeFromProject();

            // Task listener
            const tasksQuery = query(getTasksCollection(projectId));
            unsubscribeFromTasks = onSnapshot(tasksQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const task = { id: change.doc.id, ...change.doc.data() };
                    tasksData[task.id] = task;

                    if (change.type === "added") {
                        if (!document.getElementById(task.id)) {
                            renderTask(task);
                            if (task.status === 'done') {
                                triggerConfetti();
                            }
                        }
                    } else if (change.type === "modified") {
                        renderTask(task);
                        if (task.status === 'done' && change.oldIndex !== change.newIndex) {
                            triggerConfetti();
                        }
                    } else if (change.type === "removed") {
                        const taskCard = document.getElementById(task.id);
                        if (taskCard) {
                            taskCard.remove();
                            delete tasksData[task.id];
                        }
                    }
                });
                renderTasks();
            }, (error) => {
                console.error("Error listening to tasks:", error);
            });

            // Project listener to update details in realtime
            const projectDocRef = doc(getProjectCollection(), projectId);
            unsubscribeFromProject = onSnapshot(projectDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const project = { id: docSnap.id, ...docSnap.data() };
                    projectsData[project.id] = project;
                    displayProjectDetails(project);
                    
                    // Update project name in dropdown if it changed
                    const option = projectSelect.querySelector(`option[value="${projectId}"]`);
                    if (option) {
                        option.textContent = project.name;
                    }

                    // Update UI permissions based on new role/members
                    const isProjectAdmin = project.members.some(m => m.uid === currentUserId && m.role === 'admin');
                    const isSuperAdmin = currentUserRole === 'admin';
                    if (isProjectAdmin || isSuperAdmin) {
                        showElement(editProjectBtn);
                        showElement(manageMembersBtn);
                        showElement(deleteProjectBtn);
                        showElement(addTaskContainer);
                        kanbanBoard.querySelectorAll('.task-card').forEach(card => card.classList.add('is-admin'));
                    } else {
                        hideElement(editProjectBtn);
                        hideElement(manageMembersBtn);
                        hideElement(deleteProjectBtn);
                        hideElement(addTaskContainer);
                        kanbanBoard.querySelectorAll('.task-card').forEach(card => card.classList.remove('is-admin'));
                    }

                    // Log the modification
                    logEvent(projectId, 'project_modified', {
                        modifiedBy: displayUserId.textContent,
                        projectName: project.name
                    });

                } else {
                    // Project was deleted
                    console.log("Project was deleted from Firestore.");
                    showModal("The selected project was deleted.");
                    fetchProjects();
                    projectSelect.value = "";
                    displayProjectDetails(null);
                    renderTasks();
                }
            }, (error) => {
                console.error("Error listening to project:", error);
            });
        }
        
        function renderTasks() {
            // Clear all columns
            document.getElementById('todo').innerHTML = '<h2 class="text-xl font-semibold text-gray-700 sticky top-0 bg-gray-200 py-2">To Do</h2>';
            document.getElementById('in-progress').innerHTML = '<h2 class="text-xl font-semibold text-blue-700 sticky top-0 bg-blue-200 py-2">In Progress</h2>';
            document.getElementById('in-review').innerHTML = '<h2 class="text-xl font-semibold text-yellow-700 sticky top-0 bg-yellow-200 py-2">In Review</h2>';
            document.getElementById('done').innerHTML = '<h2 class="text-xl font-semibold text-green-700 sticky top-0 bg-green-200 py-2">Done</h2>';

            if (!currentProjectId) {
                return;
            }
            
            // Render tasks into their respective columns, ordered by creation date
            const orderedTasks = Object.values(tasksData).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            orderedTasks.forEach(task => {
                renderTask(task);
            });
        }
        
        function renderTask(task) {
            const taskCard = document.getElementById(task.id);
            if (taskCard) {
                taskCard.remove(); // Remove old card to re-render
            }

            const taskContainer = document.getElementById(task.status);
            if (!taskContainer) return; // Column doesn't exist, maybe project was just deleted

            const card = document.createElement('div');
            card.id = task.id;
            card.className = `task-card bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer flex flex-col gap-2 relative ${task.status === 'done' ? 'border-l-8 border-green-500' : (task.priority === 'high' ? 'border-l-8 border-red-500' : 'border-l-8 border-transparent')}`;
            if (currentUserRole === 'admin' || (projectsData[currentProjectId] && projectsData[currentProjectId].members.some(m => m.uid === currentUserId && m.role === 'admin'))) {
                 card.draggable = true;
                 card.classList.add('is-admin');
            } else {
                 card.draggable = false;
                 card.classList.remove('is-admin');
            }

            let badgeColor = 'bg-gray-400';
            if (task.status === 'done') badgeColor = 'bg-green-500';
            else if (task.status === 'in-progress') badgeColor = 'bg-blue-500';
            else if (task.status === 'in-review') badgeColor = 'bg-yellow-500';

            const formattedDeadline = task.deadline ? new Date(task.deadline).toLocaleDateString() : 'N/A';
            
            card.innerHTML = `
                <div class="flex items-center justify-between">
                    <h4 class="text-lg font-semibold text-gray-800 break-words">${task.title}</h4>
                    <span class="text-xs font-medium px-2.5 py-0.5 rounded-full text-white ${badgeColor}">${task.status.replace('-', ' ')}</span>
                </div>
                ${task.assignee ? `<p class="text-sm text-gray-600">Assigned: <span class="font-medium">${task.assignee}</span></p>` : ''}
                <p class="text-sm text-gray-500">Deadline: <span class="font-medium">${formattedDeadline}</span></p>
                <div class="flex items-center gap-2 mt-2">
                    <div class="flex items-center text-xs text-gray-500">
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M16 16h.01"></path></svg>
                        <span>${task.subtasks ? task.subtasks.filter(st => st.completed).length : 0}/${task.subtasks ? task.subtasks.length : 0}</span>
                    </div>
                    <div class="flex items-center text-xs text-gray-500">
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.549A9.962 9.962 0 0112 2C17.97 2 21 5.582 21 12z"></path></svg>
                        <span>${task.comments ? task.comments.length : 0}</span>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', (e) => {
                // Ignore click if a button inside the card was clicked
                if (e.target.closest('button')) {
                    e.stopPropagation();
                    return;
                }
                openTaskModal(task.id);
            });

            // Handle drag-and-drop events
            card.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', task.id);
                e.currentTarget.classList.add('dragging');
                // Temporarily disable click to prevent modal opening on drag
                e.currentTarget.style.pointerEvents = 'none';
            });
            card.addEventListener('dragend', (e) => {
                e.currentTarget.classList.remove('dragging');
                // Re-enable click
                e.currentTarget.style.pointerEvents = 'auto';
            });

            // Use insertBefore to maintain order
            const existingCards = Array.from(taskContainer.querySelectorAll('.task-card'));
            const existingTaskIds = existingCards.map(c => c.id);
            const taskIds = Object.values(tasksData).filter(t => t.status === task.status).sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)).map(t => t.id);

            const taskIndex = taskIds.indexOf(task.id);
            const nextTaskId = taskIds[taskIndex + 1];
            const nextSibling = document.getElementById(nextTaskId);
            
            if (nextSibling) {
                taskContainer.insertBefore(card, nextSibling);
            } else {
                taskContainer.appendChild(card);
            }
        }
        
        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over-empty');
            // Check if the dragged item is a task-card
            const draggedElementId = event.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(draggedElementId);
            if (draggedElement && draggedElement.classList.contains('task-card')) {
                 event.dataTransfer.dropEffect = 'move';
            } else {
                 event.dataTransfer.dropEffect = 'none';
            }
        }

        kanbanBoard.addEventListener('dragenter', (e) => {
            if (e.target.classList.contains('kanban-column')) {
                e.preventDefault();
                e.target.classList.add('drag-over-empty');
            }
        });

        kanbanBoard.addEventListener('dragleave', (e) => {
            if (e.target.classList.contains('kanban-column')) {
                e.target.classList.remove('drag-over-empty');
            }
        });

        async function drop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over-empty');
            const taskId = event.dataTransfer.getData('text/plain');
            const newStatus = event.currentTarget.id;

            if (currentProjectId) {
                 const taskRef = doc(getTasksCollection(currentProjectId), taskId);
                 await updateDoc(taskRef, {
                    status: newStatus
                 });
                 
                 const taskTitle = tasksData[taskId]?.title || 'N/A';
                 showToast('Task Updated', `Task "${taskTitle}" moved to "${newStatus.toUpperCase()}"`);
                 logEvent(currentProjectId, 'task_status_change', {
                    taskId: taskId,
                    taskTitle: taskTitle,
                    oldStatus: tasksData[taskId]?.status,
                    newStatus: newStatus
                 });
            }
        }

        // Modal Handlers
        function openProjectModal(isEdit = false) {
            projectModal.querySelector('#modal-title').textContent = isEdit ? 'Edit Project' : 'Create New Project';
            projectSubmitBtn.textContent = isEdit ? 'Save Changes' : 'Create';
            if (!isEdit) {
                projectForm.reset();
            }
            showElement(projectModal);
        }

        function closeProjectModal() {
            hideElement(projectModal);
            projectForm.reset();
        }

        function openTaskModal(taskId) {
            const task = tasksData[taskId];
            if (!task) return;
            selectedTaskForModal = task;
            
            // Populate form
            taskModalTitleInput.value = task.title;
            taskModalDescription.value = task.description || '';
            taskModalStatus.value = task.status;
            taskModalPriority.value = task.priority || 'low';
            taskModalDeadline.value = task.deadline || '';
            taskModalAssignee.value = task.assignee || '';

            renderSubtasks(task.subtasks || []);
            renderComments(task.comments || []);
            
            const isTaskAdmin = currentUserRole === 'admin' || (projectsData[currentProjectId] && projectsData[currentProjectId].members.some(m => m.uid === currentUserId && m.role === 'admin'));
            if (isTaskAdmin) {
                deleteTaskBtn.classList.remove('hidden');
                taskModalSaveBtn.classList.remove('hidden');
            } else {
                deleteTaskBtn.classList.add('hidden');
                taskModalSaveBtn.classList.add('hidden');
            }

            showElement(taskModal);
        }

        function closeTaskModal() {
            hideElement(taskModal);
            selectedTaskForModal = null;
            // Clear lists
            subtasksList.innerHTML = '';
            commentsList.innerHTML = '';
        }

        function openManageMembersModal() {
            if (!currentProjectId) return;
            const project = projectsData[currentProjectId];
            if (!project) return;
            renderMembers(project.members);
            showElement(manageMembersModal);
        }
        
        function closeManageMembersModal() {
            hideElement(manageMembersModal);
        }

        function openRecentEventsModal() {
            if (!currentProjectId) {
                showModal("Please select a project to view events.");
                return;
            }
            
            fetchRecentEvents(currentProjectId);
            showElement(recentEventsModal);
        }

        function closeRecentEventsModal() {
            hideElement(recentEventsModal);
            eventsList.innerHTML = '';
        }

        closePasswordModalBtn.addEventListener('click', () => {
            hideElement(changePasswordModal);
            changePasswordForm.reset();
        });

        // Subtask and Comment rendering
        function renderSubtasks(subtasks) {
            subtasksList.innerHTML = '';
            subtasks.forEach((subtask, index) => {
                const li = document.createElement('li');
                li.className = `flex items-center gap-2 p-2 rounded-md ${subtask.completed ? 'bg-gray-100 text-gray-500 line-through' : 'bg-white text-gray-800'} relative subtask-item`;
                li.innerHTML = `
                    <input type="checkbox" data-index="${index}" class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out">
                    <span class="flex-grow">${subtask.text}</span>
                    <div class="subtask-reactions-container">
                        <span class="reaction-button not-reacted" data-reaction-type="up">👍
                            <span class="text-xs ml-1">${subtask.reactions?.up || 0}</span>
                            <span class="reaction-tooltip text-white text-xs px-2 py-1 rounded">Liked by ${subtask.upReactors?.map(r => usersData[r]?.nickname || r).join(', ') || 'no one'}</span>
                        </span>
                        <span class="reaction-button not-reacted" data-reaction-type="down">👎
                            <span class="text-xs ml-1">${subtask.reactions?.down || 0}</span>
                            <span class="reaction-tooltip text-white text-xs px-2 py-1 rounded">Disliked by ${subtask.downReactors?.map(r => usersData[r]?.nickname || r).join(', ') || 'no one'}</span>
                        </span>
                        <span class="reaction-button not-reacted" data-reaction-type="happy">😄
                            <span class="text-xs ml-1">${subtask.reactions?.happy || 0}</span>
                            <span class="reaction-tooltip text-white text-xs px-2 py-1 rounded">Made happy by ${subtask.happyReactors?.map(r => usersData[r]?.nickname || r).join(', ') || 'no one'}</span>
                        </span>
                        <span class="reaction-button not-reacted" data-reaction-type="sad">😞
                            <span class="text-xs ml-1">${subtask.reactions?.sad || 0}</span>
                            <span class="reaction-tooltip text-white text-xs px-2 py-1 rounded">Made sad by ${subtask.sadReactors?.map(r => usersData[r]?.nickname || r).join(', ') || 'no one'}</span>
                        </span>
                    </div>
                    <div class="comment-note-actions">
                        <button type="button" class="delete-button" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x h-4 w-4"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>
                `;
                li.querySelector('input[type="checkbox"]').checked = subtask.completed;
                
                // Add click listener for the checkbox
                li.querySelector('input[type="checkbox"]').addEventListener('change', async (e) => {
                    const subtaskIndex = parseInt(e.target.dataset.index);
                    const isChecked = e.target.checked;
                    await updateSubtaskStatus(subtaskIndex, isChecked);
                });
                
                li.querySelectorAll('.reaction-button').forEach(button => {
                    const reactionType = button.dataset.reactionType;
                    if (subtask[`${reactionType}Reactors`]?.includes(currentUserId)) {
                        button.classList.add('reacted');
                        button.classList.remove('not-reacted');
                    }
                    button.addEventListener('click', async () => {
                        await toggleSubtaskReaction(index, reactionType);
                    });
                });
                
                li.querySelector('.delete-button').addEventListener('click', async () => {
                    const subtaskIndex = parseInt(li.querySelector('.delete-button').dataset.index);
                    await deleteSubtask(subtaskIndex);
                });

                subtasksList.appendChild(li);
            });
        }
        
        async function updateSubtaskStatus(index, completed) {
            if (!selectedTaskForModal || !currentProjectId) return;
            const updatedSubtasks = selectedTaskForModal.subtasks || [];
            if (index >= 0 && index < updatedSubtasks.length) {
                updatedSubtasks[index].completed = completed;
                const taskRef = doc(getTasksCollection(currentProjectId), selectedTaskForModal.id);
                try {
                    await updateDoc(taskRef, {
                        subtasks: updatedSubtasks
                    });
                    showToast('Subtask Updated', `Subtask marked as ${completed ? 'complete' : 'incomplete'}.`);
                    logEvent(currentProjectId, 'subtask_status_change', {
                        taskId: selectedTaskForModal.id,
                        subtaskIndex: index,
                        completed: completed
                    });
                } catch (error) {
                    console.error("Error updating subtask:", error);
                    showModal("Failed to update subtask. Please try again.");
                }
            }
        }
        
        async function toggleSubtaskReaction(index, reactionType) {
            if (!selectedTaskForModal || !currentProjectId) return;
            const taskRef = doc(getTasksCollection(currentProjectId), selectedTaskForModal.id);
            
            let currentSubtasks = selectedTaskForModal.subtasks || [];
            let currentReactions = currentSubtasks[index].reactions || {};
            let currentReactors = currentSubtasks[index][`${reactionType}Reactors`] || [];
            
            const userAlreadyReacted = currentReactors.includes(currentUserId);
            
            if (userAlreadyReacted) {
                // Remove reaction
                currentReactions[reactionType] = (currentReactions[reactionType] || 1) - 1;
                currentReactors = currentReactors.filter(uid => uid !== currentUserId);
            } else {
                // Add reaction
                currentReactions[reactionType] = (currentReactions[reactionType] || 0) + 1;
                currentReactors.push(currentUserId);
            }
            
            currentSubtasks[index].reactions = currentReactions;
            currentSubtasks[index][`${reactionType}Reactors`] = currentReactors;
            
            try {
                await updateDoc(taskRef, {
                    subtasks: currentSubtasks
                });
                showToast('Reaction Updated', `${userAlreadyReacted ? 'Removed' : 'Added'} a ${reactionType} reaction.`);
            } catch (error) {
                console.error("Error updating reaction:", error);
                showModal("Failed to update reaction. Please try again.");
            }
        }

        function renderComments(comments) {
            commentsList.innerHTML = '';
            comments.forEach((comment, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-100 p-3 rounded-lg relative group';
                div.innerHTML = `
                    <p class="text-sm text-gray-800">${comment.text}</p>
                    <p class="text-xs text-gray-500 mt-1">
                        <span class="font-semibold">${comment.user}</span> on
                        <span>${new Date(comment.timestamp).toLocaleString()}</span>
                    </p>
                    <div class="comment-note-actions hidden group-hover:flex">
                        <button type="button" class="edit-button" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil h-4 w-4"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                        </button>
                        <button type="button" class="delete-button" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 h-4 w-4"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                `;
                commentsList.appendChild(div);

                div.querySelector('.delete-button').addEventListener('click', async () => {
                    await deleteComment(index);
                });

                div.querySelector('.edit-button').addEventListener('click', () => {
                    const newText = prompt("Edit your comment:", comment.text);
                    if (newText !== null && newText.trim() !== '') {
                        editComment(index, newText.trim());
                    }
                });
            });
        }
        
        async function editComment(index, newText) {
            if (!selectedTaskForModal || !currentProjectId) return;
            const updatedComments = [...(selectedTaskForModal.comments || [])];
            if (index >= 0 && index < updatedComments.length) {
                updatedComments[index].text = newText;
                const taskRef = doc(getTasksCollection(currentProjectId), selectedTaskForModal.id);
                try {
                    await updateDoc(taskRef, {
                        comments: updatedComments
                    });
                    showToast('Comment Updated', 'Comment has been successfully edited.');
                    logEvent(currentProjectId, 'comment_edited', {
                        taskId: selectedTaskForModal.id,
                        commentIndex: index
                    });
                } catch (error) {
                    console.error("Error editing comment:", error);
                    showModal("Failed to edit comment. Please try again.");
                }
            }
        }
        
        async function deleteComment(index) {
            if (!selectedTaskForModal || !currentProjectId) return;
            const updatedComments = [...(selectedTaskForModal.comments || [])];
            if (index >= 0 && index < updatedComments.length) {
                updatedComments.splice(index, 1);
                const taskRef = doc(getTasksCollection(currentProjectId), selectedTaskForModal.id);
                try {
                    await updateDoc(taskRef, {
                        comments: updatedComments
                    });
                    showToast('Comment Deleted', 'Comment has been successfully deleted.');
                    logEvent(currentProjectId, 'comment_deleted', {
                        taskId: selectedTaskForModal.id,
                        commentIndex: index
                    });
                } catch (error) {
                    console.error("Error deleting comment:", error);
                    showModal("Failed to delete comment. Please try again.");
                }
            }
        }

        function renderMembers(members) {
            membersList.innerHTML = '';
            members.forEach(member => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-md';
                div.innerHTML = `
                    <div class="flex flex-col">
                        <p class="font-semibold">${member.nickname}</p>
                        <p class="text-sm text-gray-500">${member.email}</p>
                    </div>
                    <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${member.role === 'admin' ? 'bg-indigo-200 text-indigo-800' : 'bg-green-200 text-green-800'}">${member.role}</span>
                    <button class="remove-member-btn bg-red-500 text-white text-xs px-2 py-1 rounded-md hover:bg-red-600 transition-colors" data-uid="${member.uid}">Remove</button>
                `;
                membersList.appendChild(div);
            });
            membersList.querySelectorAll('.remove-member-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const memberUid = e.target.dataset.uid;
                    removeMemberFromProject(currentProjectId, memberUid);
                });
            });
        }
        
        async function fetchRecentEvents(projectId) {
            if (!projectId) return;

            try {
                const eventsQuery = query(getEventsCollection(projectId));
                const querySnapshot = await getDocs(eventsQuery);

                const events = [];
                querySnapshot.forEach(doc => {
                    events.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp descending
                events.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

                renderEvents(events);
            } catch (error) {
                console.error("Error fetching events:", error);
                showModal("Failed to fetch recent events. Please try again.");
            }
        }

        function renderEvents(events) {
            eventsList.innerHTML = '';
            if (events.length === 0) {
                eventsList.innerHTML = '<li class="text-center text-gray-500">No recent events.</li>';
                return;
            }

            events.forEach(event => {
                const li = document.createElement('li');
                li.className = 'border-b border-gray-200 last:border-b-0 py-2';
                let eventText = '';
                const timestamp = event.timestamp.toDate().toLocaleString();

                if (event.eventType === 'task_status_change') {
                    eventText = `Task "${event.details.taskTitle}" moved from ${event.details.oldStatus.toUpperCase()} to ${event.details.newStatus.toUpperCase()}.`;
                } else if (event.eventType === 'project_modified') {
                    eventText = `Project details updated by ${event.details.modifiedBy}.`;
                } else if (event.eventType === 'comment_added') {
                    eventText = `New comment added to task "${event.details.taskTitle}" by ${event.details.user}.`;
                } else if (event.eventType === 'comment_edited') {
                    eventText = `Comment edited on task "${tasksData[event.details.taskId]?.title || 'N/A'}"`;
                } else if (event.eventType === 'comment_deleted') {
                    eventText = `Comment deleted on task "${tasksData[event.details.taskId]?.title || 'N/A'}"`;
                } else if (event.eventType === 'subtask_status_change') {
                     eventText = `Subtask status changed on task "${tasksData[event.details.taskId]?.title || 'N/A'}"`;
                } else if (event.eventType === 'task_created') {
                     eventText = `New task "${event.details.taskTitle}" was created.`;
                } else if (event.eventType === 'task_deleted') {
                     eventText = `Task "${event.details.taskTitle}" was deleted.`;
                } else {
                    eventText = `An event occurred: ${JSON.stringify(event.details)}`;
                }
                
                li.innerHTML = `
                    <p class="font-medium">${eventText}</p>
                    <span class="text-xs text-gray-400">${timestamp}</span>
                `;
                eventsList.appendChild(li);
            });
        }
        
        // Confetti Effect
        function triggerConfetti() {
            const confettiContainer = document.getElementById('confetti-container');
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confettiContainer.appendChild(confetti);

                // Remove confetti after animation to prevent memory leak
                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }
        
        // Event Listeners
        projectSelect.addEventListener('change', (e) => {
            currentProjectId = e.target.value;
            if (currentProjectId) {
                setupRealtimeListener(currentProjectId);
                displayProjectDetails(projectsData[currentProjectId]);
            } else {
                if (unsubscribeFromTasks) unsubscribeFromTasks();
                if (unsubscribeFromProject) unsubscribeFromProject();
                renderTasks();
                displayProjectDetails(null);
                hideElement(addTaskContainer);
            }
        });

        createProjectBtn.addEventListener('click', () => {
            if (currentUserRole !== 'admin') {
                showModal("You must be an admin to create a project.");
                return;
            }
            openProjectModal();
        });

        closeProjectModalBtn.addEventListener('click', closeProjectModal);
        
        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const project = {
                name: projectNameInput.value,
                description: projectDescriptionInput.value,
                startDate: projectStartDateInput.value,
                endDate: projectEndDateInput.value,
                status: projectStatusInput.value,
                members: [{ uid: currentUserId, email: auth.currentUser.email, nickname: displayUserId.textContent, role: 'admin' }]
            };

            if (projectSubmitBtn.textContent === 'Create') {
                await createProject(project);
            } else {
                await updateProject(currentProjectId, project);
            }
        });

        editProjectBtn.addEventListener('click', () => {
            if (!currentProjectId || !projectsData[currentProjectId]) return;
            const project = projectsData[currentProjectId];
            projectNameInput.value = project.name;
            projectDescriptionInput.value = project.description;
            projectStartDateInput.value = project.startDate;
            projectEndDateInput.value = project.endDate;
            projectStatusInput.value = project.status;
            openProjectModal(true);
        });

        deleteProjectBtn.addEventListener('click', () => {
            if (currentProjectId) {
                deleteProject(currentProjectId);
            }
        });

        manageMembersBtn.addEventListener('click', openManageMembersModal);
        closeMembersModalBtn.addEventListener('click', closeManageMembersModal);

        addMemberBtn.addEventListener('click', async () => {
            if (currentProjectId) {
                const email = newMemberEmailInput.value;
                const role = newMemberRoleSelect.value;
                if (email) {
                    await addMemberToProject(currentProjectId, email, role);
                    newMemberEmailInput.value = '';
                    openManageMembersModal(); // Re-render the modal
                } else {
                    showModal("Please enter a member's email.");
                }
            }
        });

        addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskTitle = taskInput.value.trim();
            const taskDeadline = taskDeadlineInput.value;
            if (!taskTitle || !currentProjectId) return;

            const newTask = {
                title: taskTitle,
                status: 'todo',
                createdAt: new Date().toISOString(),
                deadline: taskDeadline,
                priority: 'low',
                subtasks: [],
                comments: []
            };
            
            try {
                await addDoc(getTasksCollection(currentProjectId), newTask);
                showToast('Task Added', `New task "${taskTitle}" has been added.`);
                logEvent(currentProjectId, 'task_created', {
                    taskTitle: taskTitle
                });
                addTaskForm.reset();
            } catch (error) {
                console.error("Error adding task:", error);
                showModal("Failed to add task. Please try again.");
            }
        });

        taskModalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedTaskForModal || !currentProjectId) return;

            const updatedTask = {
                title: taskModalTitleInput.value,
                description: taskModalDescription.value,
                status: taskModalStatus.value,
                priority: taskModalPriority.value,
                deadline: taskModalDeadline.value,
                assignee: taskModalAssignee.value,
                // Subtasks and comments are handled by their own listeners
            };
            
            const taskRef = doc(getTasksCollection(currentProjectId), selectedTaskForModal.id);
            try {
                await updateDoc(taskRef, updatedTask);
                showToast('Task Saved', `Task "${updatedTask.title}" has been saved.`);
                logEvent(currentProjectId, 'task_modified', {
                    taskId: selectedTaskForModal.id,
                    taskTitle: updatedTask.title
                });
                closeTaskModal();
            } catch (error) {
                console.error("Error saving task:", error);
                showModal("Failed to save task. Please try again.");
            }
        });
        
        deleteTaskBtn.addEventListener('click', async () => {
             if (!selectedTaskForModal || !currentProjectId) return;
             const confirmed = window.confirm("Are you sure you want to delete this task?");
             if (!confirmed) return;

             const taskRef = doc(getTasksCollection(currentProjectId), selectedTaskForModal.id);
             try {
                 await deleteDoc(taskRef);
                 showToast('Task Deleted', `Task "${selectedTaskForModal.title}" has been deleted.`);
                 logEvent(currentProjectId, 'task_deleted', {
                    taskTitle: selectedTaskForModal.title
                 });
                 closeTaskModal();
             } catch (error) {
                 console.error("Error deleting task:", error);
                 showModal("Failed to delete task. Please try again.");
             }
        });

        closeTaskModalBtn.addEventListener('click', closeTaskModal);

        addSubtaskBtn.addEventListener('click', async () => {
            if (!selectedTaskForModal || !currentProjectId) return;
            const newSubtaskText = newSubtaskInput.value.trim();
            if (newSubtaskText === '') return;
            
            const taskRef = doc(getTasksCollection(currentProjectId), selectedTaskForModal.id);
            try {
                await updateDoc(taskRef, {
                    subtasks: arrayUnion({ text: newSubtaskText, completed: false, reactions: {} })
                });
                newSubtaskInput.value = '';
                showToast('Subtask Added', `New subtask has been added to the task.`);
                logEvent(currentProjectId, 'subtask_added', {
                    taskId: selectedTaskForModal.id
                });
            } catch (error) {
                console.error("Error adding subtask:", error);
                showModal("Failed to add subtask. Please try again.");
            }
        });

        addCommentBtn.addEventListener('click', async () => {
            if (!selectedTaskForModal || !currentProjectId) return;
            const newCommentText = newCommentInput.value.trim();
            if (newCommentText === '') return;
            
            const taskRef = doc(getTasksCollection(currentProjectId), selectedTaskForModal.id);
            try {
                await updateDoc(taskRef, {
                    comments: arrayUnion({ text: newCommentText, user: displayUserId.textContent, timestamp: new Date().toISOString() })
                });
                newCommentInput.value = '';
                showToast('Comment Added', 'New comment has been added to the task.');
                logEvent(currentProjectId, 'comment_added', {
                    taskId: selectedTaskForModal.id,
                    taskTitle: selectedTaskForModal.title,
                    user: displayUserId.textContent
                });
            } catch (error) {
                console.error("Error adding comment:", error);
                showModal("Failed to add comment. Please try again.");
            }
        });
        
        recentEventsBtn.addEventListener('click', openRecentEventsModal);
        closeEventsModalBtn.addEventListener('click', closeRecentEventsModal);
        generalModalCloseBtn.addEventListener('click', closeModal);
        
        // Drag and drop event listeners for the columns
        document.getElementById('todo').addEventListener('dragover', allowDrop);
        document.getElementById('in-progress').addEventListener('dragover', allowDrop);
        document.getElementById('in-review').addEventListener('dragover', allowDrop);
        document.getElementById('done').addEventListener('dragover', allowDrop);

        document.getElementById('todo').addEventListener('drop', drop);
        document.getElementById('in-progress').addEventListener('drop', drop);
        document.getElementById('in-review').addEventListener('drop', drop);
        document.getElementById('done').addEventListener('drop', drop);
        
        initializeFirebase();
    </script>
<script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered! Scope:', registration.scope);
                    })
                    .catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>
